import logging

import numpy as np
import sksdr

_log = logging.getLogger(__name__)

def test_symbol_sync():
    mod = sksdr.QPSK
    sps = 2
    K = 1.0
    A = 1 / np.sqrt(2)
    damp_factor = 1.0
    norm_loop_bw = 0.01

    in_frame = np.array([
       -0.00001940952177043791-0.000015698909952685536j,
        0.00045504183194606325-0.00013286298404358807j ,
       -0.00042450747486277374-0.00025437545501390973j ,
        0.0001923909288544504 +0.0004612717592110326j  ,
        0.0004005235264655796 -0.001320053414637717j   ,
       -0.000625509460606032  +0.0013039078636736998j  ,
        0.00040399244697894967-0.0024597026677076164j  ,
       -0.0021938812853893024 +0.002004492181584175j   ,
        0.013938691402720292  +0.00903945317080884j    ,
       -0.013672972206868894  -0.021574189536444414j   ,
       -0.12415260099589616   -0.006962035331842773j   ,
       -0.17059351091383776   +0.095992137724738j      ,
       -0.057961470980332636  +0.12195256751120961j    ,
        0.03645908139392493   +0.0025501761086182497j  ,
       -0.013752942901524644  -0.0558504234465463j     ,
       -0.08842246328469827   -0.027707356161776314j   ,
       -0.13227926346390084   -0.06392597850840492j    ,
       -0.11058394394716732   -0.06467796805683831j    ,
       -0.06279997424029128   +0.13885449697471877j    ,
       -0.1291076606205923    +0.707130472006586j      ,
       -0.15120667275261254   +1.420781425662896j      ,
       -0.03362229590381882   +1.6826816966269362j     ,
        0.08738753809080135   +1.4841177101967205j     ,
        0.07279825299317902   +1.2853521505681407j     ,
       -0.06901752329430136   +1.3601616257851836j     ,
       -0.10462021078009477   +1.426522043891903j      ,
       -0.37483070322119666   +1.5008336932095818j     ,
       -0.6216000979261183    +1.950800894163329j      ,
       -0.24478520633756762   +1.6221691119125512j     ,
        0.10162015965575538   -0.034473836015486106j   ,
        0.34218812503673157   -1.606351459620057j      ,
        0.6467763094784384    -2.3223686026317405j     ,
        0.36479934641541645   -1.890446283438096j      ,
       -0.1819607398419365    -0.3846726963986691j     ,
       -0.4268114307848103    +1.2619498360994652j     ,
       -0.3050618986693503    +2.269329397060908j      ,
        0.17045694537401693   +1.8333140960325425j     ,
        0.5517004006338371    -0.0721745027701167j     ,
        0.18845164160559438   -1.3182349135635585j     ,
       -0.7560655649324566    -0.13476054103889654j    ,
       -0.7104329784590824    +1.3353509776002044j     ,
        0.35009066338811484   +0.20669847930614269j    ,
        0.5854444168383153    -1.4662800776897578j     ,
       -0.21360017646463864   -0.5050905604654803j     ,
       -0.28419659346087467   +1.6305774562493887j     ,
        0.8050879300878254    +2.000491910344557j      ,
        1.5866586035230548    +0.5509828358574167j     ,
        1.208638842458495     -1.0644868634973585j     ,
        0.7721845820228046    -1.6361977050979393j     ,
        1.2194141898467004    -0.8868597714486423j     ,
        1.483574758770675     +0.3453314184181189j     ,
        0.680804310027458     +1.1704885072896554j     ,
       -0.3227624094780427    +1.5196227383351397j     ,
       -0.5849819112678465    +1.6628415068640967j     ,
       -0.5203483742655325    +1.4256996305138445j     ,
       -0.8980424091460095    +0.6212698719420405j     ,
       -1.2812508712216308    -0.4322066772307866j     ,
       -0.9036045167777809    -1.2401809785284037j     ,
        0.08637036831056366   -1.3617583369664485j     ,
        0.9591243117431674    -0.6166792696233876j     ,
        1.2708891023726876    +0.3487245363298392j     ,
        0.7508702612686348    +0.6954232872084282j     ,
       -0.2596206430834367    +0.9248987288683215j     ,
       -0.5641031609198606    +1.4957168691660492j     ,
       -0.27304967750129977   +1.3296302417031036j     ,
       -0.6571089514571343    +0.3307635208526583j     ,
       -1.2796326527794408    -0.2855315099040194j     ,
       -1.2813179263549683    -0.3215607929598997j     ,
       -1.2413292077996712    -0.2090333931424108j     ,
       -1.4698189815390013    -0.1288654404173116j     ,
       -1.2313850505320592    -0.3126651076969787j     ,
       -0.28231671312744056   -0.8305435856834644j     ,
        0.6583679180265688    -1.1240965050619718j     ,
        1.0452494404037687    -0.6256493399603615j     ,
        0.9431325017946738    +0.3699124932201121j     ,
        0.3977407220978401    +1.1083634937088185j     ,
       -0.3383606067751414    +1.2095283531133063j     ,
       -0.8351694853191955    +0.6043129567855701j     ,
       -1.090865137563974     -0.18553361614765537j    ,
       -1.0968707112636673    -0.5095513414350292j     ,
       -0.9125888297669265    -0.2579089070882565j     ,
       -0.6870468413289487    +0.4679060069778932j     ,
       -0.5427888962433844    +0.8160576777744473j     ,
       -0.8650234690344715    +0.15384775131723358j    ,
       -0.9148867707313975    -0.37291083392089225j    ,
        0.16527810321252356   -0.06901848390267673j    ,
        1.0419591725581474    +0.42550980676257244j    ,
        0.5271010688912767    +0.730880932133957j      ,
       -0.4996044644966106    +0.8902498218312822j     ,
       -0.8634452675934421    +0.972653210536248j      ,
       -0.3792311238741197    +1.0027127430043765j     ,
        0.5095885728034772    +0.8752989241513754j     ,
        0.89330801971181      +0.24029850672384584j    ,
       -0.023484007423529407  -0.5700370475633341j     ,
       -0.9584892727107827    -0.5201665541751622j     ,
       -0.18997057480386775   +0.10783955725129954j    ,
        0.9754643008671755    +0.42426399288556826j    ,
        0.6411923052319689    +0.6581241306503353j     ,
       -0.35332932155077024   +0.7956533753922088j     ,
       -0.7421721255188325    +0.18397620063621367j    ,
       -0.8832546773550578    -0.44190229253550906j    ,
       -0.9220881210766352    +0.12369007415956135j    ,
       -0.3240207837630871    +0.9602442895123953j     ,
        0.5027551960702743    +0.7251916535737271j     ,
        0.9980788404934354    +0.23209309905793735j    ,
        1.261875547583271     +0.40823371263056j       ,
        1.0110102417660742    +0.4453539637858521j     ,
       -0.12786495400871103   -0.20852646211374587j    ,
       -1.015935859823508     -0.5098539292497393j     ,
       -0.23718132918326196   +0.0152745454377302j     ,
        0.8316025848152715    +0.4302942299545201j     ,
        0.32025104173792085   +0.7373474952272701j     ,
       -0.40412010687804145   +0.9329542496256129j     ,
       -0.03792560109622795   +0.17463450868531363j    ,
        0.4185179593186864    -0.8608829186376141j     ,
        0.3647219547529664    -1.0231194180049539j     ,
        0.3219048571785903    -0.8223929989653331j     ,
        0.5505013130806959    -0.9221359184666975j     ,
        0.5206616873031835    -0.8125438790289646j     ,
       -0.09347909959127466   -0.019663009876456427j   ,
       -0.45795712754320966   +0.8968837140278427j     ,
        0.22070761169041792   +1.0970619238973955j     ,
        0.8317869124754762    +0.6191864138798601j     ,
        0.12519537173970635   +0.42220321023107843j    ,
       -0.4946745918811575    +0.6194287599029714j     ,
        0.15505167269056555   +0.050080316570386654j   ,
        0.5118405600906168    -0.9169823201831955j     ,
       -0.22956373063505053   -0.8380409043169461j     ,
       -0.8482115871370564    -0.2809833541619208j     ,
       -0.8900339915792539    -0.3983169167089255j     ,
       -0.9373618165733703    -0.495050548330986j      ,
       -0.9464416034480193    +0.2479632995718652j     ,
       -0.6593784033293777    +0.7557941851086852j     ,
       -0.6470869432919253    +0.05486193342617385j    ,
       -0.8189422258785427    -0.5424920215899545j     ,
       -0.09630114662724065   -0.05660982156549975j    ,
        0.7337405947903117    +0.550899822352153j      ,
        0.2285156078201453    +0.8373271224198174j     ,
       -0.4051699062329932    +0.8642434760280376j     ,
        0.13149267427907554   +0.13844321136412285j    ,
        0.6561103042605401    -0.8126633146770577j     ,
        0.17083971071171028   -0.8634479283032123j     ,
       -0.5621075321385613    -0.48614839766078743j    ,
       -0.8591710395457832    -0.6345422611275967j     ,
       -0.9349765619851442    -0.6285922164168024j     ,
       -0.8140655419484312    +0.19873774830718582j    ,
       -0.5979712991648938    +0.6536837853215502j     ,
       -0.6910326132485475    +0.05094767455555499j    ,
       -0.6940170260082924    -0.5047135102584165j     ,
       -0.10988885684317377   -0.2505701507639328j     ,
        0.7211505101895764    +0.32435911330106254j    ,
        1.1846886661699658    +0.5250306941914946j     ,
        0.8088350362069932    +0.5037444365512289j     ,
       -0.14344189102600333   +0.7533519507752315j     ,
       -0.6323383466364034    +0.9200663653284551j     ,
       -0.17484874662628294   +0.39628484901605354j    ,
        0.41947530392228016   -0.5651889773996805j     ,
        0.4986241234321424    -0.9967878581215566j     ,
        0.5016564087747191    -0.5867034119306711j     ,
        0.5631257558246586    +0.10617208418335913j    ,
        0.5959928339485222    +0.5269376236863399j     ,
        0.760960121995867     +0.11069697209923443j    ,
        0.5452814221176254    -0.7143421715521918j     ,
       -0.17783048153827302   -0.8179092371900805j     ,
       -0.7514016633808583    -0.5969001266189944j     ,
       -0.9497841203837629    -0.7356641197321236j     ,
       -0.6633478435869381    -0.5558969941120029j     ,
        0.11770142590161489   +0.13838152841176848j    ,
        0.6923176017867152    +0.3823849916091774j     ,
        0.38395461821641863   -0.1986571136180335j     ,
       -0.5557818142605889    -0.58891647025686j       ,
       -1.113914028347641     -0.03537509744841838j    ,
       -0.734849249611869     +0.7831355046104562j     ,
        0.17906212279544786   +0.9805479308553333j     ,
        0.9096015094564086    +0.5042007399353445j     ,
        0.987147540876347     -0.2363870181537701j     ,
        0.4197692692144122    -0.8238779941048013j     ,
       -0.4239917155089879    -0.9628907673880565j     ,
       -0.8821655843750311    -0.49107923685433397j    ,
       -0.32694430296881205   +0.15193024573433545j    ,
        0.5882700144246453    +0.46414604649680646j    ,
        0.8350488982682003    +0.6253626039287268j     ,
        0.8405309030941203    +0.5221329868570462j     ,
        1.0361742140915207    -0.2764183289609533j     ,
        0.537153537536467     -0.80261500529727j       ,
       -0.5258631594629313    +0.05495075476700678j    ,
       -0.6730973130937828    +0.9178849457958093j     ,
        0.0485920354343322    +0.2514678254749779j     ,
        0.5652003044979041    -0.757620176392759j      ,
        0.7631380253990477    -0.8906354256842497j     ,
        0.5894389536079234    -0.827008252962486j      ,
       -0.15835284751859063   -0.9361779895830995j     ,
       -0.6096361660405217    -0.7229972967314606j     ,
       -0.0070164513573656995 -0.4859898294274819j     ,
        0.4935779328940213    -0.8236694542102333j     ,
       -0.11335902858080893   -1.1135824164522896j     ,
       -0.6179935510265837    -0.6213651026361082j     ,
        0.051282516907838485  +0.14325774867143684j    ,
        0.6873271170573665    +0.45795953427678815j    ,
        0.1712129956738913    +0.5958062402858753j     ])

    expected_frame = np.array([
        0.                    +0.j                    ,
        0.00045504183194606325-0.00013286298404358807j,
        0.00019239095131405592+0.00046127169953936043j,
       -0.000625503991047037  +0.0013038937523887353j ,
       -0.0021936594410494783 +0.0020046825330427547j ,
       -0.01367376131356991   -0.021574596884554223j  ,
       -0.17058869276311073   +0.09600779050934206j   ,
        0.03646583859244239   +0.0025241528605583255j ,
       -0.08850339571545747   -0.027726520041101377j  ,
       -0.11057768118209219   -0.06468349249557807j   ,
       -0.12911549549201634   +0.7071900262328085j    ,
       -0.03391739107323899   +1.6829837670074899j    ,
        0.0730280636152674    +1.285450342500413j     ,
       -0.10435923504930421   +1.426348869730055j     ,
       -0.6218611665331598    +1.9499406674304791j    ,
        0.10065109406522066   -0.026554470776619765j  ,
        0.6493039828099624    -2.3346240087232j       ,
       -0.19271052068182715   -0.34918350764655787j   ,
       -0.2970119471026417    +2.292105983578127j     ,
        0.5540482169449233    -0.09433480707899503j   ,
       -0.7811399312132625    -0.06478396423613934j   ,
        0.3834154489845994    +0.12799825630160586j   ,
       -0.2352063557547754    -0.4523947814836018j    ,
        0.8216814690993856    +1.995342062734069j     ,
        1.2139192546756332    -1.058158900986729j     ,
        1.215030883309646     -0.8959299829209432j    ,
        0.6887763494158518    +1.1683408097505774j    ,
       -0.5875453065986004    +1.6642551304789044j    ,
       -0.8899873372384255    +0.6375132470876778j    ,
       -0.9179215160609208    -1.2354533170565436j    ,
        0.9490698799067947    -0.6404847492988661j    ,
        0.7737630460671475    +0.6956987105583854j    ,
       -0.5719460995733634    +1.486763094143802j     ,
       -0.6349416929057569    +0.3633458029168643j    ,
       -1.2899645660118655    -0.3301512578272602j    ,
       -1.4657833023932099    -0.12692908684361412j   ,
       -0.32196193654692634   -0.8129849127578831j    ,
        1.0489173261254594    -0.6604507000328658j    ,
        0.4306885490623712    +1.0964034604323345j    ,
       -0.8236862890365719    +0.6486884867571237j    ,
       -1.1064454630799543    -0.5176498486136625j    ,
       -0.6972150836904739    +0.4299099573179752j    ,
       -0.8458781118252996    +0.20366973720609016j   ,
        0.09450462361437995   -0.10579300291497379j   ,
        0.5843578754656225    +0.7250883727845516j    ,
       -0.8795803056850817    +0.971720533162076j     ,
        0.4667687591685125    +0.8978517228622711j    ,
        0.04797702782997082   -0.5476726466574942j    ,
       -0.2665074162740675    +0.0752324029980533j    ,
        0.7068066436868098    +0.650960715856507j     ,
       -0.7429125098381866    +0.24191988501507516j   ,
       -0.941663626641849     +0.0440211602325864j    ,
        0.4527711246097275    +0.7802147434407857j    ,
        1.2670951866750226    +0.3826819182786586j    ,
       -0.04084747240977166   -0.15934453115125916j   ,
       -0.31068342668697924   -0.021919010879470957j  ,
        0.3793153986909309    +0.7286305796586262j    ,
       -0.09135633626935058   +0.2521520500788982j    ,
        0.38283036127394887   -1.0493637043353699j    ,
        0.5322562208678986    -0.9111097091371199j    ,
       -0.033294863745490844  -0.1108967923622809j    ,
        0.13886509258616503   +1.129373998665531j     ,
        0.22361860129475364   +0.4133611523184811j    ,
        0.06951263978130012   +0.13609694096976044j   ,
       -0.13632414329378406   -0.8992125989692281j    ,
       -0.9082516535087548    -0.3638029850828808j    ,
       -0.9584519354416745    +0.16299188920087965j   ,
       -0.6315929144686548    +0.14895940574606037j   ,
       -0.18897523484134549   -0.1380777946700359j    ,
        0.3285101718305785    +0.8355533156763867j    ,
        0.025584559886926095  +0.2551663188672287j    ,
        0.276747636015355     -0.9185318795454923j    ,
       -0.8586487391863051    -0.5999524372215721j    ,
       -0.8432705205216467    +0.07883221989846587j   ,
       -0.670120673850388     +0.1664458754050091j    ,
       -0.2153889438747541    -0.3341896866248936j    ,
        1.1927974566730042    +0.5323478621394402j    ,
       -0.014937271528199604  +0.7108124053339271j    ,
       -0.2854205967030613    +0.5170402014875659j    ,
        0.5202050645229509    -1.0173267485025104j    ,
        0.553480843182039     +0.01581386426130595j   ,
        0.7541310352188072    +0.22838458560698582j   ,
       -0.06958673486291303   -0.8615889027310051j    ,
       -0.9718831879416943    -0.7162300775430247j    ,
        0.004568380942336109  +0.048292195108247504j  ,
        0.4913536046586128    -0.10429272272566664j   ,
       -1.1172784751887526    -0.15026192887765816j   ,
        0.060494033128144775  +1.0224593102416586j    ,
        1.0421186402335338    -0.1495402234413237j    ,
       -0.34175882598337914   -0.9976375763089045j    ,
       -0.4418783892916689    +0.09606248542670624j   ,
        0.8502915482556148    +0.6278795516831366j    ,
        1.0393000586524352    -0.17934661968016588j   ,
       -0.4428318071623186    -0.08185379169154638j   ,
       -0.03840219211871326   +0.3806733800901507j    ,
        0.7740820608781789    -0.924384433059227j     ,
       -0.06167217403691509   -0.9314402414595253j    ,
       -0.11400934942587365   -0.48497235537363326j   ,
       -0.0028636887583518567 -1.1221186543315091j    ,
       -0.07270280692867603   +0.07124285584203287j   ])

    sym_sync = sksdr.SymbolSync(mod, sps, damp_factor, norm_loop_bw, K, A)
    out_frame = np.empty_like(in_frame)
    timing_err = np.empty_like(in_frame)

    nret = sym_sync(in_frame, out_frame, timing_err)
    assert np.allclose(out_frame[:nret], expected_frame)
